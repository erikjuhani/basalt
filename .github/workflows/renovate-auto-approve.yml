name: Renovate Auto-approve

on:
  pull_request:
    types: [opened, synchronize, reopened, auto_merge_enabled]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions: {}

jobs:
  auto-approve:
    runs-on: ubuntu-latest
    if: github.event.pull_request.user.login == 'renovate-updater[bot]'

    steps:
      - uses: actions/create-github-app-token@7e473efe3cb98aa54f8d4bac15400b15fad77d94 # v2.2.0
        id: app-token
        with:
          app-id: ${{ vars.RENOVATE_APPROVER_APP_ID }}
          private-key: ${{ secrets.RENOVATE_APPROVER_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: |
            basalt

      - name: Check and approve
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          RENOVATE_APPROVER_APP_NAME: renovate-pr-approver[bot]
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;

            const { data: pr } = await github.rest.pulls.get({ owner, repo, pull_number });

            if (!pr.auto_merge) {
              console.log("Auto-merge not enabled, skipping");
              process.exit(0);
            }

            const { data: reviews } = await github.rest.pulls.listReviews({ owner, repo, pull_number });

            const prApproved = reviews.some(
              (review) =>
                review.state === "APPROVED" && review.user.login === process.env.RENOVATE_APPROVER_APP_NAME
            );

            if (prApproved) {
              console.log("Already approved, skipping");
              process.exit(0);
            }

            await github.rest.pulls.createReview({ owner, repo, pull_number, event: "APPROVE" });
